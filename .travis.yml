language: ruby
sudo: false
dist: trusty
services:
  - mongodb
jdk:
  - oraclejdk8
env:
  global:
    - TEST_CLUSTER_NODES=1
matrix:
  include:
    - rvm: 2.3.8
      gemfile: gemfiles/rails.4.2.es.5.kaminari.0.17.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.4.7
      gemfile: gemfiles/rails.4.2.mongoid.5.4.es.5.kaminari.0.17.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.es.5.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.mongoid.6.4.es.5.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.sequel.4.49.es.5.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.es.5.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.mongoid.master.es.5.gemfile
      env: ES_VERSION=5.6.16
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.sequel.5.24.es.5.gemfile
      env: ES_VERSION=5.6.16

    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.es.6.gemfile
      env: ES_VERSION=6.8.3
    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.mongoid.6.4.es.6.gemfile
      env: ES_VERSION=6.8.3
    - rvm: 2.5.6
      gemfile: gemfiles/rails.5.2.sequel.4.49.es.6.gemfile
      env: ES_VERSION=6.8.3
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.es.7.gemfile
      env: ES_VERSION=7.3.2
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.mongoid.master.es.7.gemfile
      env: ES_VERSION=7.3.2
    - rvm: 2.6.4
      gemfile: gemfiles/rails.6.0.sequel.5.24.es.7.gemfile
      env: ES_VERSION=7.3.2
  allow_failures:
    - env: ES_VERSION=6.8.3
    - env: ES_VERSION=7.3.2
before_install:
  - curl -s https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.16.tar.gz | tar xz -C /tmp
  - curl -s https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.3.tar.gz | tar xz -C /tmp
  - curl -s https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.3.2-linux-x86_64.tar.gz | tar xz -C /tmp
before_script:
  - TEST_CLUSTER_COMMAND=/tmp/elasticsearch-$ES_VERSION/bin/elasticsearch TEST_CLUSTER_LOGS=/tmp/log rake es:start
script:
  - bundle exec rspec
  - bundle exec rubocop
